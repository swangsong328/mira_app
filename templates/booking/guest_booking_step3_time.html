{% extends 'base.html' %}
{% load static %}

{% block title %}Book an Appointment - Choose Time{% endblock %}

{% block content %}
<article>
    <header>
        <h1>Book: {{ service.name }}</h1>
        <p>Step 3 of 4: Choose Date & Time</p>
        {% if any_staff %}
        <small><strong>Staff:</strong> Any Available</small>
        {% elif staff %}
        <small><strong>Staff:</strong> {{ staff.get_full_name }}</small>
        {% endif %}
    </header>

    {% if slots_by_date %}
    <form method="post">
        {% csrf_token %}
        
        {% for date, slots in slots_by_date.items %}
        <details {% if forloop.first %}open{% endif %} style="margin-bottom: 1rem;">
            <summary style="cursor: pointer; font-weight: bold; padding: 0.5rem; background: var(--card-background-color); border-radius: 0.25rem;">
                {{ slots.0.start_time|date:"l, F j, Y" }}
                <small style="font-weight: normal;">({{ slots|length }} slots available)</small>
            </summary>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 0.5rem; margin-top: 1rem;">
                {% for slot in slots %}
                <label style="cursor: pointer; text-align: center; border: 1px solid var(--muted-border-color); border-radius: 0.25rem; padding: 0.5rem; transition: all 0.2s;">
                    <input type="radio" name="slot_id" value="{{ slot.id }}" required style="display: none;">
                    <div>
                        <strong>{{ slot.start_time|date:"g:i A" }}</strong>
                        {% if any_staff %}
                        <br><small>{{ slot.staff.get_full_name }}</small>
                        {% endif %}
                    </div>
                </label>
                {% endfor %}
            </div>
        </details>
        {% endfor %}

        <footer style="margin-top: 2rem; display: flex; gap: 1rem;">
            <a href="{% url 'guest_booking_step2_staff' %}" role="button" class="secondary">← Back</a>
            <button type="submit">Next: Enter Details →</button>
        </footer>
    </form>

    <style>
        /* Visual feedback for selected time slot */
        input[type="radio"]:checked + div {
            background: var(--primary);
            color: white;
        }
        label:has(input[type="radio"]:checked) {
            border-color: var(--primary);
            background: var(--primary-focus);
        }
    </style>

    {% else %}
    <p>No available time slots found. Please try selecting a different staff member or check back later.</p>
    <footer>
        <a href="{% url 'guest_booking_step2_staff' %}" role="button" class="secondary">← Back</a>
    </footer>
    {% endif %}
</article>
{% endblock %}

